---
title: 'Project Proposal: Happiness Report’s top tier for multiple consecutive years'
author: "Amal Dagan, Bar Evron, Niv Dolev, Roni London"
output:
  pdf_document:
    number_sections: true
    fig_caption: true
    latex_engine: xelatex
  html_document:
    df_print: paged
---

\newpage

```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```
```{r libreries}
library(tidyverse)
library(dplyr)
library(stringr)
library(ggplot2)
library(patchwork)
library(caret)
library(pROC)
library(readxl)  # חבילה לטעינת קבצי אקסל
```

# Introduction

**Research Question**  
Which indicators enable a country to remain in the World Happiness Report’s top tier for multiple consecutive years?

**Background**  
GDP per capita, social support, life expectancy and perceived freedom are repeatedly cited as key drivers of well-being.

**Current Gap and existing research**  
Several studies have examined national happiness using WHR data, though few have explored long-term patterns.
For example, Kuppens et al. (2023) analyzed cultural factors in 78 countries before and after the COVID-19 pandemic. They found that individualism and indulgence became stronger predictors of happiness post-COVID, suggesting that global crises may shift the importance of cultural values. However, their analysis compared only two time points (2017–2019 vs. 2021) and did not assess whether these associations hold across a longer period.
Similarly, Al‐Maatouq and Al Shammari (2022) examined the relationship between WHR scores, Hofstede’s cultural dimensions, and government education spending across 58 countries. They found that countries with higher long-term orientation and lower power distance tended to score higher on the WHR, indicating possible structural links between culture and well-being. However, their study was cross-sectional and did not account for how such associations might change over time.
Despite the value of these contributions, our research takes a unique direction. We combine an unusually broad dataset—spanning 2011 to 2024 and covering over 150 countries—with repeated-measures modeling to assess which happiness predictors remain robust over time. Unlike studies that focus on a single year or a narrow method, our approach allows us to explore both consistency and change in global well-being, providing updated and policy-relevant insights.

**Method & “Stability Score”**  
A longitudinal logistic model is re-estimated for each vintage; a variable earns a stability score when its effect remains significant in all fourteen years.

**Contribution**  
Turning the dataset’s continual renewal from hurdle to asset, we deliver up-to-date policy guidance and reveal whether the perennial “Top-20” countries stay happy for the same reasons or for shifting, time-dependent ones.

# Data

We use publicly available data from the World Happiness Report, based on the Gallup World Poll, covering the years 2011 to 2023. The dataset contains 1,969 yearly observations across 125 to 153 countries per year, with 14 variables per country-year entry. Each observation represents a single country in a given year.
The variables include social, health, and economic factors widely studied in happiness research, such as: social support, GDP per capita, healthy life expectancy, freedom to make life choices, generosity, and perceptions of corruption. Our binary outcome variable indicates whether a country was ranked in the Top 20 happiest countries that year. Importantly, the happiness score itself is not a single-year estimate but a three-year rolling average, meaning each year’s score reflects data from the current and two previous years. For example, the 2022 score is an average of survey results from 2020, 2021, and 2022. This design introduces temporal dependence between consecutive years.
To address this, we plan to either: use repeated-measures models (e.g., mixed-effects models) that account for within-country correlations across time, or aggregate data at the country level to study long-term patterns, such as overall average happiness or total number of Top 20 appearances.

A detailed data dictionary is included in the /data/README.md file in our repository.

# Preliminary Results
```{r loaoding data}
# טען את קובץ הנתונים



happiness_data <- read_csv("happiness_data_clean_2011_2024.csv")

#glimpse(happiness_data)
#head(happiness_data)
#summary(happiness_data)

happiness_data <- happiness_data %>%
  mutate(`Country name` = trimws(`Country name`))
happiness_data <- happiness_data %>%
  group_by(`Country name`) %>%
  fill(
    `Ladder score`, upperwhisker, lowerwhisker,
    `Explained by: Log GDP per capita`, `Explained by: Social support`,
    `Explained by: Healthy life expectancy`, `Explained by: Freedom to make life choices`,
    `Explained by: Generosity`, `Explained by: Perceptions of corruption`,
    `Dystopia + residual`,
    .direction = "downup"
  ) %>%
  ungroup()
# מחיקה לדוג' של מדינות לא אמיתיות (אם יש)
happiness_data <- happiness_data %>%
  filter(!is.na(`Ladder score`)) # או עמודה עיקרית אחרת
#write_csv(happiness_data, "happiness_data_clean_2011_2024.csv")


```

```{r summary, echo=FALSE, warning=FALSE, message=FALSE}
#summary(happiness_data %>% 
#  select(`Ladder score`, 
#         `Explained by: Log GDP per capita`, 
#         `Explained by: Social support`,
#         `Explained by: Healthy life expectancy`, 
#         `Explained by: Freedom to make life choices`))
```


```{r plots-and-table, fig.width=9, fig.height=5, echo=FALSE, warning=FALSE, message=FALSE}

happiness_data <- happiness_data %>%
  group_by(Year) %>%
  mutate(Top_20 = Rank <= 20) %>%
  ungroup() %>%
  rename(Country_name = `Country name`, Ladder_score = `Ladder score`, Log_GDP = `Explained by: Log GDP per capita`, Social_support = `Explained by: Social support`, Life_expectancy = `Explained by: Healthy life expectancy`, Freedom_of_choices = `Explained by: Freedom to make life choices`, Generosity = `Explained by: Generosity`, Dystopia_and_residual = `Dystopia + residual`, Corruption = `Explained by: Perceptions of corruption` )
happiness_data <- happiness_data %>%
  arrange(Country_name, Year) %>%  # Sort by country and year
  group_by(Country_name) %>%      # Process each country separately
  mutate(Was_in_Top20_Last_Year = lag(Top_20)) %>%  # Get last year's Top_20
  ungroup() %>%  # Remove grouping
  mutate(Was_in_Top20_Last_Year = case_when(
    is.na(Was_in_Top20_Last_Year) ~ 2,         # No previous data
    Was_in_Top20_Last_Year == 1 ~ 1,           # Was in top 20
    Was_in_Top20_Last_Year == 0 ~ 0            # Was not in top 20
  ))
#colnames(happiness_data)

# סופרים לכל מדינה בכמה שנים הייתה בטופ 20
top_countries_long <- happiness_data %>%
  filter(Top_20) %>%
  count(Country_name, name = "Years_in_Top_20") %>%
  arrange(desc(Years_in_Top_20))

# תצוגה - 25 הראשונות
#print(top_countries_long, n=25)


tpl1 <- top_countries_long %>%
  filter(Years_in_Top_20 >= 5) %>% # תבחרי את הסף שמתאים לויזואליות
  ggplot(aes(x = reorder(Country_name, Years_in_Top_20), y = Years_in_Top_20)) +
  geom_col(fill = "lightgreen") +
  coord_flip() +
  labs(
    title = "Number of Years Each Country was in the Top 20",
    x = "Country",
    y = "Years in Top 20"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 13)
  )

plt1 <- ggplot(happiness_data, aes(x = Social_support, y = Ladder_score)) +
  geom_point(alpha=0.4) +
  geom_smooth(method="lm", se=FALSE, color="blue") +
  labs(title="Ladder score vs Social support")

plt <- ggplot(happiness_data, aes(x=Rank)) + geom_histogram(color="darkblue", fill="lightblue", binwidth=3) +
  labs(title="Distribution of rankings")+
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(size = 12, face = "bold"),
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 13)
  )
```


```{r top_countries_long, fig.width=10, fig.height=5, echo=FALSE, warning=FALSE, message=FALSE}
tpl1 | plt
```

The distribution of the number of years in the top 20 is kept pretty limited, only 14 countries have never left the top 20 spot.
This goes to show that being a top country is a perpetual title. Which means there is merit to asking this question, we think there is a pattern of data that indicates how consistent a country is at staying at the top of the list.


#```{r plot_Ladder_score ,fig.width=15, fig.height=5, echo=FALSE, warning=FALSE, message=FALSE}
#plt1
#```

#This graph's purpose is to show that the columns are good predictors for the ladder score, and by extension being a top country. This wasn't unexpected, it's logical that an indicator of a positive trait in a country's society would impact its overall happiness. And since the ladder score is what dictates where a country is ranked, it will also probably take part in the model for our question.




# Work Plan

The outcome is the Top-20 column and the predictors currently are all of the columns. The way we will answer the question is that we will attempt to find the most contributing variables  in order to answer the question.

we will use a variety of methods to answer the question:
SHAP variables,desicion-tree and a logistic regression model, we will attempt to build those models concurrently and to compare and contrast them.

we would like to receive some conclusive results(the p_value of some of the variables will be significant),in all models so after comparison we could isolate the most relevant factors.

- Data preparation and cleaning. (Bar)
- Exploratory analysis and visualization. (Roni)
- Model building and evaluation. (Roni,Niv)
- Interpretation of results and final reporting. (Amal,Niv)


\newpage

Appendix\newline  
This Markdown file describes the data structure and organization for the project.\newline  

we will also elaborate about the pre project data cleaning,\newline  
this data is a addition of WHR(world happiness reports) from 2011 to 2024.\newline  
the data cleaning included fixing the country names(where the standard of naming was changed in between the reports),erasing countries that dont exist and deleting duplicates.\newline  
we also changed the column names(not all of the column names were identical in all the reports.)\newline  

Data Columns: \newline  
1. YEAR: the year in which the survey was conducted (the data is from 2011–2024)\newline  
2. Rank – the country's Rank in the according year (from 1 to 158); not all countries were ranked plus the rank is by 3 year average.\newline  
3. Country name – the abbreviated name of the relevant country.\newline  
4. Ladder score – the WHR provides a number of the final happiness score of the current country (from 1.3 to 7.9).\newline  
5. upperwhisker – the upper boundary of the whisker score (from 1.43 to 7.91).\newline  
6. lowerwhisker – the lower boundary of the whisker score (from 1.3 to 7.78).\newline  
7. Log GDP per capita – a normalized version of the country's GDP index in comparison to the rest of the world (normalized in range from 0 to 2.2).\newline  
8. Social support – a normalized version of the country's social support index in comparison to the rest of the world (normalized in range from 0 to 1.8).\newline  
9. Healthy life expectancy – a normalized version of the country's healthy life expectancy index in comparison to the rest of the world (normalized in range from 0 to 1.13).\newline  
10. Freedom to make life choices – a normalized version of the country's freedom to make life choices index in comparison to the rest of the world (normalized in range from 0 to 1.018).\newline  
11. Generosity – a normalized version of the country's generosity index in comparison to the rest of the world (normalized in range from 0 to 0.57).\newline  
12. Perceptions of corruption – a normalized version of the country's perceptions of corruption index in comparison to the rest of the world (normalized in range from 0 to 0.587).\newline  
13. Dystopia + residual – a normalized version of the country's dystopia + residual index in comparison to the rest of the world (normalized in range from -0.11 to 3.482).\newline  
14. Top 20 – a binary variable indicating whether the country is in the top 20 in that particular year (the outcome variable).\newline  

Rows: 1,969\newline  
Columns: 14\newline  
$ Year <dbl> 2024, 2023, 2022, 2021, 2020, 2019…\newline  
$ Rank <dbl> 1, 143, 137, 146, 150, 153, 154,…\newline  
$ Country_name <chr> "Finland", "Afghanistan", "Afghanistan", …\newline  
$ Ladder_score <dbl> 7.7360, 1.7210, 1.8590, 2.4040, …\newline  
$ upperwhisker <dbl> 7.810000, 1.775000, 1.923000, 2.…\newline  
$ lowerwhisker <dbl> 7.662000, 1.667000, 1.795000, 2.…\newline  
$ Log_GDP <dbl> 1.7490000, 0.6280000, 0.6450000,…\newline  
$ Social_support <dbl> 1.7830000, 0.0000000, 0.0000000,…\newline  
$ Life_expectancy <dbl> 0.8240000, 0.2420000, 0.0870000,…\newline  
$ Freedom_of_choices <dbl> 0.9860000, 0.0000000, 0.0000000,…\newline  
$ Generosity <dbl> 0.1100000, 0.0910000, 0.0930000,…\newline  
$ Corruption <dbl> 0.502000000, 0.088000000, 0.0590…\newline
$ Dystopia_and_residual <dbl> 1.782000, 0.672000, 0.976000, 1.…\newline  
$ Top_20 <lgl> TRUE, FALSE, FALSE, FALSE, FALSE…\newline  

		
\\\
**models and fun**
The main model: Decision Tree
Like logistic regression this is also a popular model for classification problems, and since it can be visualized it is an obvious choice to be one of the models.
The second model example: Logistic Regression
If we're to take a classification route, then logistic regression would be a good model for that. We got good results, but again maybe too good. All of the predictors seem to be strong predictors which was good for the sake of showing that there is a correlation, but the performance was too accurate to use as the main model. 

```{r logistic regression model , echo=FALSE, warning=FALSE, message=FALSE}
## removing null countries

null_countries = c("Angola", "Bhutan", "Syria", "Djibouti", "Oman", "Guyana", "Puerto Rico", "Qatar", "Somaliland Region", "Suriname", "Sudan", "Syria")
happiness_data<-happiness_data %>% filter(!(Country_name %in% null_countries))
# happiness_data

## logistic regression example



set.seed(123)

# renamed to Corruption for simplicity.
# happiness_data <- happiness_data %>% rename(Corruption = `Explained by: Perceptions of corruption`)

happiness_data <- happiness_data[sample(nrow(happiness_data)), ]
sample <- sample(c(TRUE, FALSE), nrow(happiness_data), replace=TRUE, prob=c(0.8,0.2))
train  <- happiness_data[sample, ]
test   <- happiness_data[!sample, ]

cols <- c("Log_GDP", "Social_support", "Life_expectancy", "Freedom_of_choices", "Generosity", "Corruption", "Dystopia_and_residual")

predictors <- paste(cols, collapse = " + ")
log_formula <- as.formula(paste("Top_20 ~", predictors))
log_formula

logmodel <- glm(log_formula,
             data = train, family = "binomial")
#summary(logmodel)

probs <- predict(logmodel, newdata = test, type = "response")
preds <- ifelse(probs > 0.5, 1, 0)

test$Top_20 <- as.integer(test$Top_20 == TRUE)
test$preds <- preds

actual <- factor(test$Top_20, levels = c(0, 1))
predicted <- factor(test$preds, levels = c(0, 1))
cm <- confusionMatrix(predicted, actual)
print(cm)



```


```{r plot_Ladder_score ,fig.width=15, fig.height=5, echo=FALSE, warning=FALSE, message=FALSE}
colnames(happiness_data)
library(dplyr)


colnames(happiness_data)
```